
-- Smart Database Schema for Monjez App (PostgreSQL)
-- This script is Idempotent.

-- 1. Enable UUID Extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 2. Handle Enums
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'transaction_type') THEN
        CREATE TYPE transaction_type AS ENUM ('income', 'expense');
    END IF;
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'loan_type') THEN
        CREATE TYPE loan_type AS ENUM ('flat', 'decreasing');
    END IF;
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'loan_status') THEN
        CREATE TYPE loan_status AS ENUM ('active', 'completed');
    END IF;
END$$;

-- USERS
CREATE TABLE IF NOT EXISTS public.users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS username VARCHAR(255);
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS password_hash VARCHAR(255);
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- SETTINGS
CREATE TABLE IF NOT EXISTS public.settings (
    user_id UUID PRIMARY KEY REFERENCES public.users(id) ON DELETE CASCADE
);
ALTER TABLE public.settings ADD COLUMN IF NOT EXISTS currency VARCHAR(10) DEFAULT 'SAR';
ALTER TABLE public.settings ADD COLUMN IF NOT EXISTS monthly_limit DECIMAL(12, 2) DEFAULT 5000.00;
ALTER TABLE public.settings ADD COLUMN IF NOT EXISTS alert_threshold INTEGER DEFAULT 80;
ALTER TABLE public.settings ADD COLUMN IF NOT EXISTS theme VARCHAR(20) DEFAULT 'system';
ALTER TABLE public.settings ADD COLUMN IF NOT EXISTS budget_rollover BOOLEAN DEFAULT FALSE;

-- INCOME SOURCES
CREATE TABLE IF NOT EXISTS public.income_sources (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.income_sources ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.income_sources ADD COLUMN IF NOT EXISTS name VARCHAR(255);
ALTER TABLE public.income_sources ADD COLUMN IF NOT EXISTS amount DECIMAL(12, 2);
ALTER TABLE public.income_sources ADD COLUMN IF NOT EXISTS day_of_month INTEGER;
ALTER TABLE public.income_sources ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- BANK CARDS
CREATE TABLE IF NOT EXISTS public.bank_cards (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS bank_name VARCHAR(255);
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS card_number VARCHAR(4);
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS account_last4 VARCHAR(4);
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS card_type VARCHAR(50);
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS color VARCHAR(20) DEFAULT '#1e293b';
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS balance DECIMAL(12, 2) DEFAULT 0.00;
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS logo_url TEXT;
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS logo_position VARCHAR(20) DEFAULT 'top-left';
ALTER TABLE public.bank_cards ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- BANK LOGOS (New)
CREATE TABLE IF NOT EXISTS public.bank_logos (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    bank_name VARCHAR(255) UNIQUE,
    logo_url TEXT
);

-- TRANSACTIONS
CREATE TABLE IF NOT EXISTS public.transactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS amount DECIMAL(12, 2);
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS type transaction_type;
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS category VARCHAR(100);
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS note TEXT;
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS date TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS card_id UUID REFERENCES public.bank_cards(id) ON DELETE SET NULL;
ALTER TABLE public.transactions ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- LOANS
CREATE TABLE IF NOT EXISTS public.loans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS name VARCHAR(255);
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS description TEXT;
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS total_amount DECIMAL(12, 2);
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS start_date DATE;
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS duration_months INTEGER;
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS interest_rate DECIMAL(5, 2);
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS type loan_type;
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS status loan_status DEFAULT 'active';
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS contract_pdf TEXT;
-- Changed to TEXT to support Base64 images
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS icon TEXT;
ALTER TABLE public.loans ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- LOAN SCHEDULE
CREATE TABLE IF NOT EXISTS public.loan_schedule (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.loan_schedule ADD COLUMN IF NOT EXISTS loan_id UUID REFERENCES public.loans(id) ON DELETE CASCADE;
ALTER TABLE public.loan_schedule ADD COLUMN IF NOT EXISTS payment_date DATE;
ALTER TABLE public.loan_schedule ADD COLUMN IF NOT EXISTS payment_amount DECIMAL(12, 2);
ALTER TABLE public.loan_schedule ADD COLUMN IF NOT EXISTS principal_component DECIMAL(12, 2);
ALTER TABLE public.loan_schedule ADD COLUMN IF NOT EXISTS interest_component DECIMAL(12, 2);
ALTER TABLE public.loan_schedule ADD COLUMN IF NOT EXISTS remaining_balance DECIMAL(12, 2);
ALTER TABLE public.loan_schedule ADD COLUMN IF NOT EXISTS is_paid BOOLEAN DEFAULT FALSE;

-- BILLS
CREATE TABLE IF NOT EXISTS public.bills (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS name VARCHAR(255);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS provider VARCHAR(100);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS type VARCHAR(50);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS amount DECIMAL(12, 2);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS has_end_date BOOLEAN DEFAULT FALSE;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS end_date DATE;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS device_details VARCHAR(255);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS start_date DATE;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS duration_months INTEGER;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS last_payment_amount DECIMAL(12, 2);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS down_payment DECIMAL(12, 2);
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS is_subscription BOOLEAN DEFAULT FALSE;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS renewal_date DATE;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'active'; 
-- Changed to TEXT to support Base64 images
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS icon TEXT;
ALTER TABLE public.bills ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- FINANCIAL GOALS
CREATE TABLE IF NOT EXISTS public.financial_goals (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.financial_goals ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.financial_goals ADD COLUMN IF NOT EXISTS name VARCHAR(255);
ALTER TABLE public.financial_goals ADD COLUMN IF NOT EXISTS target_amount DECIMAL(12, 2);
ALTER TABLE public.financial_goals ADD COLUMN IF NOT EXISTS current_amount DECIMAL(12, 2);
-- Changed to TEXT to support Base64 images
ALTER TABLE public.financial_goals ADD COLUMN IF NOT EXISTS icon TEXT;
ALTER TABLE public.financial_goals ADD COLUMN IF NOT EXISTS color VARCHAR(50);
ALTER TABLE public.financial_goals ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- RECURRING TRANSACTIONS
CREATE TABLE IF NOT EXISTS public.recurring_transactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS name VARCHAR(255);
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS amount DECIMAL(12, 2);
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS type transaction_type;
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS category VARCHAR(100);
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS day_of_month INTEGER;
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS active BOOLEAN DEFAULT TRUE;
ALTER TABLE public.recurring_transactions ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- CUSTOM CATEGORIES
CREATE TABLE IF NOT EXISTS public.custom_categories (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
ALTER TABLE public.custom_categories ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES public.users(id) ON DELETE CASCADE;
ALTER TABLE public.custom_categories ADD COLUMN IF NOT EXISTS name VARCHAR(100);
-- Changed to TEXT to support Base64 images
ALTER TABLE public.custom_categories ADD COLUMN IF NOT EXISTS icon TEXT;
ALTER TABLE public.custom_categories ADD COLUMN IF NOT EXISTS color VARCHAR(20);
ALTER TABLE public.custom_categories ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;

-- *** MIGRATION COMMANDS ***
-- Run these to fix existing tables if they were created with VARCHAR(50)
ALTER TABLE public.loans ALTER COLUMN icon TYPE TEXT;
ALTER TABLE public.bills ALTER COLUMN icon TYPE TEXT;
ALTER TABLE public.financial_goals ALTER COLUMN icon TYPE TEXT;
ALTER TABLE public.custom_categories ALTER COLUMN icon TYPE TEXT;
